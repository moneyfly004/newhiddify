# 待处理问题清单

## 🔧 内核部分

### 1. 内核启动和停止
- [ ] **问题**：当前使用 Process 启动内核，但缺少完整的生命周期管理
- [ ] **需要**：
  - 内核进程监控（崩溃检测、自动重启）
  - 内核日志收集和显示
  - 内核资源清理（内存、文件句柄）
  - 内核状态持久化（应用重启后恢复状态）

### 2. 内核配置生成
- [ ] **问题**：需要根据选择的节点和模式生成正确的内核配置
- [ ] **需要**：
  - Sing-box JSON 配置生成器
  - Clash Meta YAML 配置生成器
  - 规则模式配置（分流规则、DNS规则）
  - 全局模式配置
  - 节点选择逻辑（自动/手动）

### 3. 内核切换
- [ ] **问题**：切换内核时需要平滑过渡，避免断流
- [ ] **需要**：
  - 无缝切换机制（先启动新内核，再停止旧内核）
  - 配置迁移（从 Clash 切换到 Sing-box）
  - 状态同步（连接状态、当前节点）
  - 切换失败回滚机制

### 4. 内核适配器
- [ ] **问题**：需要统一的接口适配不同内核
- [ ] **需要**：
  - 统一的内核接口抽象
  - Sing-box 适配器实现
  - Clash Meta 适配器实现
  - 配置格式转换器

## 💾 存储部分

### 1. 本地数据存储
- [ ] **问题**：需要持久化存储用户数据、配置、状态
- [ ] **需要**：
  - 用户信息存储（SharedPreferences/Hive）
  - 订阅信息缓存
  - 节点列表缓存
  - 测速结果存储
  - 连接历史记录
  - 应用配置存储（内核类型、模式、自动连接等）

### 2. 配置存储
- [ ] **问题**：内核配置文件需要安全存储
- [ ] **需要**：
  - 配置文件加密存储
  - 配置文件版本管理
  - 配置文件备份和恢复
  - 临时配置文件清理

### 3. 状态持久化
- [ ] **问题**：应用重启后需要恢复连接状态
- [ ] **需要**：
  - 连接状态保存
  - 当前选择的订阅和节点保存
  - 内核状态恢复
  - 自动重连机制

## 🔄 订阅格式转换

### 1. 订阅格式识别
- [ ] **问题**：需要识别不同的订阅格式
- [ ] **需要**：
  - Clash YAML 格式识别
  - Sing-box JSON 格式识别
  - V2Ray JSON 格式识别
  - Base64 编码订阅识别
  - 自动格式检测

### 2. 格式转换器
- [ ] **问题**：不同内核需要不同格式的配置
- [ ] **需要**：
  - Clash YAML → Sing-box JSON 转换器
  - Sing-box JSON → Clash YAML 转换器
  - V2Ray → Clash/Sing-box 转换器
  - 节点信息提取和标准化
  - 规则配置转换

### 3. 节点解析
- [ ] **问题**：从订阅中解析节点信息
- [ ] **需要**：
  - 支持多种协议（VMess、VLESS、Trojan、Shadowsocks等）
  - 节点信息提取（名称、服务器、端口、协议等）
  - 节点去重和合并
  - 节点分组处理

### 4. 配置合并
- [ ] **问题**：多个订阅需要合并
- [ ] **需要**：
  - 多订阅合并逻辑
  - 节点去重策略
  - 分组管理
  - 优先级处理

## 🔄 自动更新订阅

### 1. 定时更新机制
- [ ] **问题**：需要定期更新订阅配置
- [ ] **需要**：
  - 定时任务调度（每30分钟/1小时）
  - 后台更新机制
  - 更新失败重试
  - 更新通知

### 2. 增量更新
- [ ] **问题**：避免全量更新，提升效率
- [ ] **需要**：
  - 订阅版本检测
  - 增量更新逻辑
  - 变更检测（新增/删除/修改节点）
  - 更新日志记录

### 3. 更新策略
- [ ] **问题**：更新时机的选择
- [ ] **需要**：
  - 连接时自动更新
  - 定时后台更新
  - 手动刷新
  - 更新冲突处理（更新时正在连接）

### 4. 更新通知
- [ ] **问题**：用户需要知道更新状态
- [ ] **需要**：
  - 更新进度显示
  - 更新结果通知
  - 更新失败提示
  - 更新日志查看

## 🎯 其他关键问题

### 1. 规则配置
- [ ] **问题**：规则模式需要配置分流规则
- [ ] **需要**：
  - 规则文件管理（本地/远程）
  - 规则更新机制
  - 自定义规则支持
  - 规则测试和验证

### 2. DNS 配置
- [ ] **问题**：需要配置 DNS 服务器
- [ ] **需要**：
  - DNS 服务器选择
  - DoH/DoT 支持
  - DNS 规则配置
  - DNS 缓存管理

### 3. 流量统计
- [ ] **问题**：需要显示流量使用情况
- [ ] **需要**：
  - 实时流量监控
  - 历史流量统计
  - 流量限制提醒
  - 流量图表展示

### 4. 连接优化
- [ ] **问题**：连接速度和稳定性优化
- [ ] **需要**：
  - 连接池管理
  - 超时设置
  - 重连机制
  - 连接质量监控

### 5. 安全性
- [ ] **问题**：数据安全和隐私保护
- [ ] **需要**：
  - 敏感数据加密
  - 本地存储加密
  - 传输加密（HTTPS）
  - 日志脱敏

### 6. 性能优化
- [ ] **问题**：应用性能和资源使用
- [ ] **需要**：
  - 内存优化
  - CPU 使用优化
  - 电池消耗优化
  - 启动速度优化

### 7. 错误处理
- [ ] **问题**：各种异常情况的处理
- [ ] **需要**：
  - 网络错误处理
  - 配置错误处理
  - 内核错误处理
  - 用户友好的错误提示

### 8. 测试和调试
- [ ] **问题**：需要完善的测试和调试工具
- [ ] **需要**：
  - 单元测试
  - 集成测试
  - 调试工具
  - 日志查看器

## 📋 优先级建议

### 高优先级（核心功能）
1. ✅ 内核启动和停止（基础）
2. ✅ 内核配置生成（必需）
3. ✅ 订阅格式转换（必需）
4. ✅ 自动更新订阅（重要）
5. ✅ 状态持久化（用户体验）

### 中优先级（增强功能）
1. 内核切换优化
2. 规则配置管理
3. DNS 配置
4. 流量统计
5. 错误处理完善

### 低优先级（优化功能）
1. 性能优化
2. 安全性增强
3. 测试和调试工具
4. 高级功能

## 🔍 技术难点

### 1. 配置格式转换
- **难点**：不同内核的配置格式差异大
- **方案**：使用中间格式（标准化节点格式），然后转换为目标格式

### 2. 无缝切换
- **难点**：切换内核时避免断流
- **方案**：先启动新内核，确认连接后再停止旧内核

### 3. 增量更新
- **难点**：检测订阅变更
- **方案**：使用版本号或哈希值比较

### 4. 状态恢复
- **难点**：应用重启后恢复连接
- **方案**：保存连接状态，启动时检查并恢复

---

**最后更新**：2024-12-22

