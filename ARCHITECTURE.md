# 架构设计文档

## 🏗️ 整体架构

### 分层架构

```
┌─────────────────────────────────────┐
│         UI Layer (Flutter)          │
│  - Pages, Widgets, Themes           │
└─────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────┐
│      Business Logic Layer           │
│  - BLoC/Cubit, Services             │
└─────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────┐
│         Data Layer                   │
│  - Repositories, API Client          │
└─────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────┐
│      Native Bridge Layer             │
│  - Method Channel, Platform Channel │
└─────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────┐
│      Native Layer (Android)          │
│  - VPN Service, Kernel Process       │
└─────────────────────────────────────┘
```

## 🔐 权限管理

### Android 权限

1. **VPN 权限**
   - 使用 `VpnService.prepare()` 请求
   - 通过 `PermissionHandler` 统一管理
   - 在连接前自动检查并请求

2. **系统权限**
   - 通知权限：用于前台服务通知
   - 电池优化：保持后台运行
   - 网络权限：基础网络访问

3. **权限请求流程**
   ```
   用户操作 → 检查权限 → 请求权限 → 处理结果 → 继续操作
   ```

## 🚀 前台服务（保活）

### 实现方案

1. **前台服务**
   - 使用 `FOREGROUND_SERVICE` 权限
   - 显示持续通知
   - 防止系统杀死进程

2. **保活策略**
   - 前台服务 + 通知
   - 忽略电池优化
   - 开机自启动（可选）

3. **服务生命周期**
   ```
   连接 → 启动前台服务 → 显示通知 → 保持运行
   断开 → 停止前台服务 → 移除通知
   ```

## 📱 优先级管理

### 进程优先级

1. **前台进程**
   - 应用在前台时：最高优先级
   - 前台服务运行：高优先级

2. **后台进程**
   - 使用前台服务保持高优先级
   - 避免被系统回收

### 内存管理

1. **资源释放**
   - 及时释放不需要的资源
   - 使用弱引用避免内存泄漏

2. **缓存策略**
   - 节点列表缓存
   - 配置缓存

## 🎨 UI 架构

### 主题系统

1. **赛博朋克主题**
   - 深色背景（#0A0A0A）
   - 霓虹色系（青色、粉色、绿色）
   - 发光效果和渐变

2. **组件设计**
   - 卡片：带霓虹边框
   - 按钮：渐变 + 发光效果
   - 输入框：霓虹边框聚焦效果

### 状态管理

1. **BLoC 模式**
   - `AuthCubit`：认证状态
   - `SubscriptionCubit`：订阅管理
   - `NodeCubit`：节点管理

2. **状态流**
   - 使用 Stream 实时更新 UI
   - 响应式设计

## 🔧 核心服务

### ConnectionManager

- 管理连接状态
- 处理连接/断开逻辑
- 监听内核状态变化

### KernelManager

- 内核切换（Sing-box / Clash Meta）
- 内核启动/停止
- 状态监控

### SpeedTestEngine

- 自动测速（每5分钟）
- 批量测速
- 智能评分

### PermissionService

- 统一权限管理
- 权限请求封装
- 权限状态检查

## 📦 数据流

### 订阅数据流

```
API → Repository → Cubit → UI
```

### 节点数据流

```
API → Repository → Cubit → 自动测速 → 更新UI
```

### 连接数据流

```
用户操作 → ConnectionManager → KernelManager → Native → 状态更新 → UI
```

## 🛡️ 安全考虑

1. **Token 管理**
   - 存储在 SecureStorage
   - 自动刷新机制

2. **配置加密**
   - 敏感配置加密存储
   - 传输使用 HTTPS

3. **权限最小化**
   - 只请求必要权限
   - 权限使用说明

## ⚡ 性能优化

1. **异步处理**
   - 所有网络请求异步
   - 不阻塞 UI 线程

2. **缓存策略**
   - 订阅信息缓存
   - 节点列表缓存

3. **资源优化**
   - 图片压缩
   - 代码混淆

## 🔄 错误处理

1. **网络错误**
   - 重试机制
   - 错误提示

2. **权限错误**
   - 引导用户授权
   - 友好提示

3. **连接错误**
   - 自动重连
   - 错误日志

## 📝 最佳实践

1. **代码组织**
   - 按功能模块划分
   - 清晰的命名规范

2. **错误处理**
   - 统一的错误处理
   - 用户友好的提示

3. **测试**
   - 单元测试
   - 集成测试

---

**最后更新**：2024-12-22

